<% var title = 'Tickets'; %>
<%- include('layout-head') %>

<h1 class="text-2xl font-bold text-gray-800 mb-6">ðŸŽ« Retention Tickets</h1>

<!-- Filters -->
<div class="flex gap-3 mb-4 flex-wrap">
  <select id="filterStatus" onchange="loadTickets()" class="border rounded-lg px-3 py-2 text-sm">
    <option value="">All Statuses</option>
    <option value="open">Open</option>
    <option value="in_progress">In Progress</option>
    <option value="completed">Completed</option>
    <option value="cancelled">Cancelled</option>
  </select>
</div>

<div id="ticketsContainer" class="space-y-2">
  <div class="bg-white rounded-xl shadow-sm p-8 text-center text-gray-400">Loading...</div>
</div>

<script>
const statusColors = { open:'bg-yellow-100 text-yellow-800', in_progress:'bg-blue-100 text-blue-800', completed:'bg-green-100 text-green-800', cancelled:'bg-gray-100 text-gray-500' };
const actionIcons = { call:'ðŸ“ž', email:'ðŸ“§', sms:'ðŸ’¬' };

async function loadTickets() {
  const status = document.getElementById('filterStatus').value;
  const url = '/api/tickets' + (status ? '?status=' + status : '');
  const res = await fetch(url);
  const tickets = await res.json();
  const container = document.getElementById('ticketsContainer');

  if (tickets.length === 0) {
    container.innerHTML = '<div class="bg-white rounded-xl shadow-sm p-8 text-center text-gray-400">No tickets found</div>';
    return;
  }

  container.innerHTML = '<div class="bg-white rounded-xl shadow-sm overflow-hidden"><table class="w-full text-sm"><thead class="bg-gray-50"><tr>' +
    '<th class="text-left px-5 py-3 text-gray-500 font-medium">Customer</th>' +
    '<th class="text-left px-5 py-3 text-gray-500 font-medium">Action</th>' +
    '<th class="text-left px-5 py-3 text-gray-500 font-medium">Scheduled</th>' +
    '<th class="text-left px-5 py-3 text-gray-500 font-medium">Offer</th>' +
    '<th class="text-left px-5 py-3 text-gray-500 font-medium">Status</th>' +
    '<th class="text-left px-5 py-3 text-gray-500 font-medium">Actions</th>' +
    '</tr></thead><tbody class="divide-y" id="ticketRows"></tbody></table></div>';

  const tbody = document.getElementById('ticketRows');
  tickets.forEach(t => {
    const sc = statusColors[t.status] || 'bg-gray-100 text-gray-600';
    const row = document.createElement('tr');
    row.className = 'hover:bg-gray-50 cursor-pointer';
    row.innerHTML = `
      <td class="px-5 py-3">
        <div class="font-medium text-gray-800">${t.customer_name||'â€”'}</div>
        <div class="text-xs text-gray-400">${t.customer_phone||''}</div>
      </td>
      <td class="px-5 py-3">${actionIcons[t.action_type]||''} ${t.action_type}</td>
      <td class="px-5 py-3 text-gray-600">${t.scheduled_date ? new Date(t.scheduled_date).toLocaleString() : 'â€”'}</td>
      <td class="px-5 py-3 text-gray-600 max-w-xs truncate">${t.offer_details||'â€”'}</td>
      <td class="px-5 py-3"><span class="badge ${sc} px-2 py-1 rounded-full text-xs font-semibold">${t.status}</span></td>
      <td class="px-5 py-3 space-x-1">
        <button onclick="event.stopPropagation();toggleExpand(${t.id})" class="px-2 py-1 bg-gray-200 rounded text-xs hover:bg-gray-300">Details</button>
        ${t.action_type==='call'&&t.customer_phone ? '<button onclick="event.stopPropagation();callTicket('+t.id+')" class="px-2 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700">ðŸ“ž Call</button>' : ''}
        ${t.status==='open'||t.status==='in_progress' ? '<button onclick="event.stopPropagation();updateStatus('+t.id+',\'completed\')" class="px-2 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700">âœ“ Complete</button><button onclick="event.stopPropagation();updateStatus('+t.id+',\'cancelled\')" class="px-2 py-1 bg-red-100 text-red-700 rounded text-xs hover:bg-red-200">âœ— Cancel</button>' : ''}
      </td>`;
    tbody.appendChild(row);

    // Expandable detail row
    const detailRow = document.createElement('tr');
    detailRow.id = 'detail-' + t.id;
    detailRow.className = 'hidden';
    detailRow.innerHTML = `<td colspan="6" class="px-5 py-4 bg-gray-50">
      <div class="grid grid-cols-2 gap-4 text-sm">
        <div><span class="font-medium text-gray-700">Email:</span> ${t.customer_email||'â€”'}</div>
        <div><span class="font-medium text-gray-700">Max Discount:</span> ${t.max_discount||0}%</div>
        <div><span class="font-medium text-gray-700">Outcome:</span> ${t.outcome||'â€”'}</div>
        <div><span class="font-medium text-gray-700">Call ID:</span> ${t.call_id||'â€”'}</div>
        <div class="col-span-2"><span class="font-medium text-gray-700">Notes:</span>
          <div class="flex gap-1 mt-1">
            <input type="text" id="tnotes-${t.id}" value="${(t.notes||'').replace(/"/g,'&quot;')}" class="flex-1 border rounded px-2 py-1 text-sm">
            <button onclick="saveTicketNotes(${t.id})" class="px-3 py-1 bg-gray-200 rounded text-xs hover:bg-gray-300">Save</button>
          </div>
        </div>
      </div>
    </td>`;
    tbody.appendChild(detailRow);
  });
}

function toggleExpand(id) {
  document.getElementById('detail-' + id).classList.toggle('hidden');
}

async function updateStatus(id, status) {
  await fetch('/api/tickets/' + id, { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify({status}) });
  loadTickets();
}

async function callTicket(id) {
  if (!confirm('Trigger a call for this ticket?')) return;
  const res = await fetch('/api/tickets/' + id + '/trigger-call', { method:'POST', headers:{'Content-Type':'application/json'} });
  const data = await res.json();
  alert(data.success ? 'Call triggered!' : 'Failed: ' + (data.error||'Unknown error'));
  loadTickets();
}

async function saveTicketNotes(id) {
  const notes = document.getElementById('tnotes-' + id).value;
  await fetch('/api/tickets/' + id, { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify({notes}) });
}

loadTickets();
</script>

<%- include('layout-foot') %>
