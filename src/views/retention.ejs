<% var title = 'Retention'; %>
<%- include('layout-head') %>

<h1 class="text-2xl font-bold text-gray-800 mb-6">Customer Retention</h1>

<div class="flex gap-3 mb-6 flex-wrap">
  <div class="flex items-center gap-2 text-xs"><span class="w-3 h-3 rounded-full bg-green-400"></span> &lt; 30 days</div>
  <div class="flex items-center gap-2 text-xs"><span class="w-3 h-3 rounded-full bg-yellow-400"></span> 30–59 days</div>
  <div class="flex items-center gap-2 text-xs"><span class="w-3 h-3 rounded-full bg-orange-400"></span> 60–89 days</div>
  <div class="flex items-center gap-2 text-xs"><span class="w-3 h-3 rounded-full bg-red-400"></span> 90–119 days</div>
  <div class="flex items-center gap-2 text-xs"><span class="w-3 h-3 rounded-full bg-red-700"></span> 120+ days</div>
</div>

<% if (customers.length === 0) { %>
  <div class="bg-white rounded-xl shadow-sm p-12 text-center">
    <p class="text-gray-400 text-lg">No customer data available</p>
  </div>
<% } else { %>
  <div class="bg-white rounded-xl shadow-sm overflow-hidden">
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead class="bg-gray-50">
          <tr>
            <th class="w-2"></th>
            <th class="text-left px-5 py-3 text-gray-500 font-medium">Customer</th>
            <th class="text-left px-5 py-3 text-gray-500 font-medium">Email</th>
            <th class="text-right px-5 py-3 text-gray-500 font-medium">Days Since Last Order</th>
            <th class="text-right px-5 py-3 text-gray-500 font-medium">Orders</th>
            <th class="text-right px-5 py-3 text-gray-500 font-medium">Total Spent</th>
            <th class="text-left px-5 py-3 text-gray-500 font-medium">Last Order</th>
          </tr>
        </thead>
        <tbody class="divide-y">
          <% customers.forEach(function(c) {
            var d = c.days_since_last_order;
            var color = d < 30 ? 'bg-green-400' : d < 60 ? 'bg-yellow-400' : d < 90 ? 'bg-orange-400' : d < 120 ? 'bg-red-400' : 'bg-red-700';
            var rowBg = d >= 90 ? 'bg-red-50' : d >= 60 ? 'bg-orange-50' : '';
          %>
            <tr class="hover:bg-gray-50 <%= rowBg %>">
              <td class="pl-2"><span class="block w-3 h-3 rounded-full <%= color %>"></span></td>
              <td class="px-5 py-3 font-medium text-gray-800"><%= c.name || '—' %></td>
              <td class="px-5 py-3 text-gray-600"><%= c.email || '—' %></td>
              <td class="px-5 py-3 text-right font-bold"><%= d %> days</td>
              <td class="px-5 py-3 text-right"><%= c.total_orders %></td>
              <td class="px-5 py-3 text-right font-semibold text-pink-600">$<%= Number(c.total_spent || 0).toFixed(2) %></td>
              <td class="px-5 py-3 text-gray-600"><%= c.last_order_date ? c.last_order_date.split('T')[0] : '—' %></td>
            </tr>
          <% }); %>
        </tbody>
      </table>
    </div>
  </div>
<% } %>

<%- include('layout-foot') %>
