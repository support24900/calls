<% var title = 'Abandoned Carts'; %>
<%- include('layout-head') %>

<h1 class="text-2xl font-bold text-gray-800 mb-6">Abandoned Carts</h1>

<% if (dailyGroups.length === 0) { %>
  <div class="bg-white rounded-xl shadow-sm p-12 text-center">
    <p class="text-gray-400 text-lg">No abandoned carts yet</p>
  </div>
<% } else { %>
  <div class="space-y-3">
    <% dailyGroups.forEach(function(group) { %>
      <div class="bg-white rounded-xl shadow-sm overflow-hidden">
        <a href="/dashboard?date=<%= group.day %>" class="flex items-center justify-between p-5 hover:bg-gray-50 transition-colors">
          <div class="flex items-center gap-4">
            <div class="w-12 h-12 bg-pink-100 rounded-lg flex items-center justify-center">
              <span class="text-pink-600 font-bold text-sm"><%= new Date(group.day + 'T00:00:00').toLocaleDateString('en', {month:'short',day:'numeric'}) %></span>
            </div>
            <div>
              <div class="font-semibold text-gray-800"><%= group.day %></div>
              <div class="text-sm text-gray-500"><%= group.count %> cart<%= group.count !== 1 ? 's' : '' %> abandoned</div>
            </div>
          </div>
          <div class="text-right">
            <div class="text-lg font-bold text-pink-600">$<%= Number(group.total_value || 0).toFixed(2) %></div>
            <svg class="w-5 h-5 text-gray-400 ml-auto <%= expandDate === group.day ? 'rotate-180' : '' %> transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
          </div>
        </a>

        <% if (expandDate === group.day && expandedCarts.length > 0) { %>
          <div class="border-t">
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="text-left px-5 py-3 text-gray-500 font-medium">Customer</th>
                    <th class="text-left px-5 py-3 text-gray-500 font-medium">Email / Phone</th>
                    <th class="text-left px-5 py-3 text-gray-500 font-medium">Total</th>
                    <th class="text-left px-5 py-3 text-gray-500 font-medium">Call Status</th>
                    <th class="text-left px-5 py-3 text-gray-500 font-medium">Recording</th>
                  </tr>
                </thead>
                <tbody class="divide-y">
                  <% expandedCarts.forEach(function(cart) { %>
                    <tr class="hover:bg-gray-50">
                      <td class="px-5 py-3 font-medium text-gray-800"><%= cart.customer_name || 'Unknown' %></td>
                      <td class="px-5 py-3 text-gray-600">
                        <div><%= cart.customer_email || '—' %></div>
                        <div class="text-xs text-gray-400"><%= cart.customer_phone || '' %></div>
                      </td>
                      <td class="px-5 py-3 font-semibold">$<%= Number(cart.cart_total || 0).toFixed(2) %></td>
                      <td class="px-5 py-3">
                        <span class="badge badge-<%= cart.call_status || 'pending' %>"><%= (cart.call_status || 'pending').toUpperCase() %></span>
                      </td>
                      <td class="px-5 py-3">
                        <% if (cart.call_recording_url) { %>
                          <audio controls preload="none" class="h-8 w-48">
                            <source src="<%= cart.call_recording_url %>" type="audio/mpeg">
                          </audio>
                        <% } else { %>
                          <span class="text-gray-300">—</span>
                        <% } %>
                      </td>
                    </tr>
                  <% }); %>
                </tbody>
              </table>
            </div>
          </div>
        <% } %>
      </div>
    <% }); %>
  </div>
<% } %>

<%- include('layout-foot') %>
