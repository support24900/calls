<% var title = 'Abandoned Carts'; %>
<%- include('layout-head') %>

<div class="flex items-center justify-between mb-6">
  <h1 class="text-2xl font-bold text-gray-800">Abandoned Carts</h1>
  <button onclick="document.getElementById('rulesPanel').classList.toggle('hidden')" class="px-4 py-2 bg-pink-600 text-white rounded-lg hover:bg-pink-700 text-sm font-medium flex items-center gap-2">
    âš™ï¸ Rules
  </button>
</div>

<!-- Rules Panel -->
<div id="rulesPanel" class="hidden bg-white rounded-xl shadow-sm p-6 mb-6 border border-pink-200">
  <h2 class="text-lg font-bold text-gray-800 mb-4">Automation Rules</h2>
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Auto-call Enabled</label>
      <label class="relative inline-flex items-center cursor-pointer">
        <input type="checkbox" id="rule_auto_call_enabled" class="sr-only peer">
        <div class="w-11 h-6 bg-gray-200 peer-focus:ring-2 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-600"></div>
        <span class="ml-2 text-sm text-gray-600" id="autoCallLabel">Off</span>
      </label>
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Call Delay</label>
      <select id="rule_call_delay" class="w-full border rounded-lg px-3 py-2 text-sm">
        <option value="30min">30 minutes</option><option value="1hr">1 hour</option><option value="2hr" selected>2 hours</option>
        <option value="4hr">4 hours</option><option value="6hr">6 hours</option><option value="12hr">12 hours</option>
        <option value="24hr">24 hours</option><option value="48hr">48 hours</option>
      </select>
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Sales Method</label>
      <select id="rule_sales_method" class="w-full border rounded-lg px-3 py-2 text-sm">
        <option value="emma_english">Emma - Aggressive English</option>
        <option value="sarit_hebrew">Sarit - Hebrew</option>
        <option value="custom">Custom</option>
      </select>
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Max Discount: <span id="discountVal">10</span>%</label>
      <input type="range" id="rule_max_discount" min="0" max="50" value="10" class="w-full accent-pink-600" oninput="document.getElementById('discountVal').textContent=this.value">
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Retry Attempts</label>
      <select id="rule_retry_attempts" class="w-full border rounded-lg px-3 py-2 text-sm">
        <option value="1">1</option><option value="2">2</option><option value="3" selected>3</option><option value="4">4</option><option value="5">5</option>
      </select>
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Retry Interval</label>
      <select id="rule_retry_interval" class="w-full border rounded-lg px-3 py-2 text-sm">
        <option value="15min">15 minutes</option><option value="30min" selected>30 minutes</option><option value="1hr">1 hour</option>
        <option value="2hr">2 hours</option><option value="4hr">4 hours</option>
      </select>
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Active Hours Start</label>
      <input type="time" id="rule_active_hours_start" value="09:00" class="w-full border rounded-lg px-3 py-2 text-sm">
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Active Hours End</label>
      <input type="time" id="rule_active_hours_end" value="21:00" class="w-full border rounded-lg px-3 py-2 text-sm">
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Minimum Cart Value ($)</label>
      <input type="number" id="rule_min_cart_value" value="0" min="0" class="w-full border rounded-lg px-3 py-2 text-sm">
    </div>
  </div>
  <div class="mt-4 flex justify-end">
    <button onclick="saveRules()" class="px-6 py-2 bg-pink-600 text-white rounded-lg hover:bg-pink-700 text-sm font-medium">ğŸ’¾ Save Rules</button>
  </div>
  <div id="rulesSaveMsg" class="hidden mt-2 text-sm text-green-600 text-right">âœ“ Rules saved!</div>
</div>

<% if (dailyGroups.length === 0) { %>
  <div class="bg-white rounded-xl shadow-sm p-12 text-center">
    <p class="text-gray-400 text-lg">No abandoned carts yet</p>
  </div>
<% } else { %>
  <div class="space-y-3">
    <% dailyGroups.forEach(function(group) { %>
      <div class="bg-white rounded-xl shadow-sm overflow-hidden">
        <a href="/dashboard?date=<%= group.day %>" class="flex items-center justify-between p-5 hover:bg-gray-50 transition-colors">
          <div class="flex items-center gap-4">
            <div class="w-12 h-12 bg-pink-100 rounded-lg flex items-center justify-center">
              <span class="text-pink-600 font-bold text-sm"><%= new Date(group.day + 'T00:00:00').toLocaleDateString('en', {month:'short',day:'numeric'}) %></span>
            </div>
            <div>
              <div class="font-semibold text-gray-800"><%= group.day %></div>
              <div class="text-sm text-gray-500"><%= group.count %> cart<%= group.count !== 1 ? 's' : '' %> abandoned</div>
            </div>
          </div>
          <div class="text-right">
            <div class="text-lg font-bold text-pink-600">$<%= Number(group.total_value || 0).toFixed(2) %></div>
            <svg class="w-5 h-5 text-gray-400 ml-auto <%= expandDate === group.day ? 'rotate-180' : '' %> transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
          </div>
        </a>

        <% if (expandDate === group.day && expandedCarts.length > 0) { %>
          <div class="border-t divide-y">
            <% expandedCarts.forEach(function(cart) {
              var items = [];
              try { items = JSON.parse(cart.items_json || '[]'); } catch(e) {}
              if (typeof items === 'string') { try { items = [{title: items}]; } catch(e) { items = []; } }
              var discounts = [];
              try { discounts = JSON.parse(cart.discount_codes || '[]'); } catch(e) {}
              var totalDisc = Number(cart.total_discounts || 0);
            %>
              <div class="p-5 hover:bg-gray-50">
                <div class="flex flex-wrap items-start justify-between gap-4">
                  <!-- Customer Info -->
                  <div class="min-w-[200px]">
                    <div class="font-semibold text-gray-800"><%= cart.customer_name || 'Unknown' %></div>
                    <div class="text-xs text-gray-500"><%= cart.customer_email || 'â€”' %></div>
                    <% if (cart.customer_phone) { %>
                      <div class="text-xs text-green-600 font-medium mt-1">ğŸ“ <%= cart.customer_phone %></div>
                    <% } else { %>
                      <div class="text-xs text-red-400 mt-1">âŒ No phone</div>
                    <% } %>
                  </div>

                  <!-- Products -->
                  <div class="flex-1 min-w-[250px]">
                    <% if (Array.isArray(items) && items.length > 0) { %>
                      <div class="space-y-2">
                        <% items.forEach(function(item) { %>
                          <div class="flex items-center gap-3">
                            <% if (item.image) { %>
                              <img src="<%= item.image %>" class="w-10 h-10 rounded-lg object-cover border" alt="">
                            <% } else { %>
                              <div class="w-10 h-10 rounded-lg bg-pink-50 flex items-center justify-center text-pink-400 text-lg">ğŸ§´</div>
                            <% } %>
                            <div>
                              <div class="text-sm font-medium text-gray-800"><%= item.title || 'Product' %></div>
                              <div class="text-xs text-gray-400">
                                Qty: <%= item.quantity || 1 %>
                                <% if (item.price) { %> Â· $<%= item.price %><% } %>
                                <% if (item.variant_title) { %> Â· <span class="text-gray-500"><%= item.variant_title %></span><% } %>
                              </div>
                            </div>
                          </div>
                        <% }); %>
                      </div>
                    <% } else { %>
                      <span class="text-gray-400 text-sm italic">No product details</span>
                    <% } %>
                  </div>

                  <!-- Total + Discount -->
                  <div class="text-right min-w-[120px]">
                    <div class="text-lg font-bold text-pink-600">$<%= Number(cart.cart_total || 0).toFixed(2) %></div>
                    <% if (discounts.length > 0) { %>
                      <% discounts.forEach(function(dc) { %>
                        <div class="mt-1">
                          <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-green-100 text-green-800">
                            ğŸ·ï¸ <%= dc.code %> <% if (dc.amount) { %>(-$<%= dc.amount %>)<% } %>
                          </span>
                        </div>
                      <% }); %>
                    <% } else if (totalDisc > 0) { %>
                      <div class="text-sm text-green-600 font-medium mt-1">ğŸ’° -$<%= totalDisc.toFixed(2) %> discount</div>
                    <% } %>
                  </div>

                  <!-- Status + Actions -->
                  <div class="min-w-[140px] text-right space-y-2">
                    <span class="badge badge-<%= cart.call_status || 'pending' %>"><%= (cart.call_status || 'pending').toUpperCase() %></span>
                    <% if (cart.customer_phone) { %>
                      <div><button onclick="openCallModal(<%= cart.id %>, '<%= cart.customer_name || 'Customer' %>', '<%= cart.customer_phone %>')" class="text-xs bg-green-500 text-white px-3 py-1.5 rounded-lg hover:bg-green-600 transition font-medium">ğŸ“ Call Now</button></div>
                    <% } %>
                    <% if (cart.call_recording_url) { %>
                      <audio controls preload="none" class="h-7 w-36">
                        <source src="<%= cart.call_recording_url %>" type="audio/mpeg">
                      </audio>
                    <% } %>
                    <div class="flex gap-1 justify-end">
                      <input type="text" id="notes-<%= cart.id %>" value="<%= cart.call_notes || '' %>" placeholder="ğŸ“ Notes..." class="border rounded px-2 py-1 text-xs w-28">
                      <button onclick="saveNotes(<%= cart.id %>)" class="px-2 py-1 bg-gray-200 rounded text-xs hover:bg-gray-300">ğŸ’¾</button>
                    </div>
                  </div>
                </div>
              </div>
            <% }); %>
          </div>
        <% } %>
      </div>
    <% }); %>
  </div>
<% } %>

<!-- Call Modal -->
<div id="callModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
  <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md mx-4">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-bold text-gray-800">ğŸ“ Make a Call</h3>
      <button onclick="closeCallModal()" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
    </div>
    <div class="mb-4 p-3 bg-gray-50 rounded-lg">
      <div class="font-medium text-gray-800" id="callModalName"></div>
      <div class="text-sm text-gray-500" id="callModalPhone"></div>
    </div>
    <div class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">ğŸ¤– Assistant (Agent)</label>
        <select id="callAssistant" class="w-full border rounded-lg px-3 py-2 text-sm">
          <option value="1fa240b4-11a1-47b1-ab46-a468d9c2ee49">Emma â€” Aggressive English ğŸ‡ºğŸ‡¸</option>
          <option value="062d92f5-cf14-492e-85c2-750f14db97df">Sarit/×©×¨×™×ª â€” Hebrew ğŸ‡®ğŸ‡±</option>
          <option value="211ff338-5b38-48bc-a305-5ed45438d30e">Ana Pena Customer Care ğŸ’†</option>
          <option value="9e89c95c-9831-4e69-b0e7-c5a3f5eabc00">MCA Sales Agent ğŸ’¼</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">ğŸ“± Call From Number</label>
        <select id="callFromNumber" class="w-full border rounded-lg px-3 py-2 text-sm">
          <option value="b84f8a12-9e25-46b7-a523-57477c52b6d9">ğŸ‡®ğŸ‡± 03-382-9645 (Israel)</option>
          <option value="97c10492-a747-40b4-a586-0eee33a47b01">ğŸ‡ºğŸ‡¸ +1-785-390-8551 (US Twilio)</option>
          <option value="a8a12554-18ae-4573-914a-d13b75e5dc93">ğŸ‡ºğŸ‡¸ +1-659-902-0549 (Vapi Free)</option>
        </select>
      </div>
    </div>
    <div class="mt-6 flex gap-3">
      <button onclick="closeCallModal()" class="flex-1 px-4 py-2 border rounded-lg text-gray-600 hover:bg-gray-50 text-sm font-medium">Cancel</button>
      <button id="callModalBtn" onclick="executeCall()" class="flex-1 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 text-sm font-medium">ğŸ“ Call</button>
    </div>
  </div>
</div>

<script>
(async function() {
  try {
    const res = await fetch('/api/cart-rules');
    const rules = await res.json();
    if (rules.auto_call_enabled === 'true') { document.getElementById('rule_auto_call_enabled').checked = true; document.getElementById('autoCallLabel').textContent = 'On'; }
    if (rules.call_delay) document.getElementById('rule_call_delay').value = rules.call_delay;
    if (rules.sales_method) document.getElementById('rule_sales_method').value = rules.sales_method;
    if (rules.max_discount) { document.getElementById('rule_max_discount').value = rules.max_discount; document.getElementById('discountVal').textContent = rules.max_discount; }
    if (rules.retry_attempts) document.getElementById('rule_retry_attempts').value = rules.retry_attempts;
    if (rules.retry_interval) document.getElementById('rule_retry_interval').value = rules.retry_interval;
    if (rules.active_hours_start) document.getElementById('rule_active_hours_start').value = rules.active_hours_start;
    if (rules.active_hours_end) document.getElementById('rule_active_hours_end').value = rules.active_hours_end;
    if (rules.min_cart_value) document.getElementById('rule_min_cart_value').value = rules.min_cart_value;
  } catch(e) {}
})();

document.getElementById('rule_auto_call_enabled').addEventListener('change', function() {
  document.getElementById('autoCallLabel').textContent = this.checked ? 'On' : 'Off';
});

async function saveRules() {
  const rules = {
    auto_call_enabled: document.getElementById('rule_auto_call_enabled').checked ? 'true' : 'false',
    call_delay: document.getElementById('rule_call_delay').value,
    sales_method: document.getElementById('rule_sales_method').value,
    max_discount: document.getElementById('rule_max_discount').value,
    retry_attempts: document.getElementById('rule_retry_attempts').value,
    retry_interval: document.getElementById('rule_retry_interval').value,
    active_hours_start: document.getElementById('rule_active_hours_start').value,
    active_hours_end: document.getElementById('rule_active_hours_end').value,
    min_cart_value: document.getElementById('rule_min_cart_value').value,
  };
  await fetch('/api/cart-rules', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(rules) });
  const msg = document.getElementById('rulesSaveMsg');
  msg.classList.remove('hidden');
  setTimeout(() => msg.classList.add('hidden'), 2000);
}

let currentCallCartId = null;
function openCallModal(cartId, name, phone) {
  currentCallCartId = cartId;
  document.getElementById('callModalName').textContent = name;
  document.getElementById('callModalPhone').textContent = phone;
  document.getElementById('callModal').classList.remove('hidden');
}
function closeCallModal() {
  document.getElementById('callModal').classList.add('hidden');
}
async function executeCall() {
  const assistantId = document.getElementById('callAssistant').value;
  const phoneNumberId = document.getElementById('callFromNumber').value;
  const btn = document.getElementById('callModalBtn');
  btn.disabled = true; btn.textContent = 'â³ Calling...';
  try {
    const res = await fetch('/api/carts/' + currentCallCartId + '/trigger-call', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ assistantId, phoneNumberId })
    });
    const data = await res.json();
    if (data.success) {
      btn.textContent = 'âœ… Call Started!';
      setTimeout(() => { closeCallModal(); btn.textContent = 'ğŸ“ Call'; btn.disabled = false; }, 2000);
    } else {
      btn.textContent = 'âŒ Failed: ' + (data.error || 'Unknown');
      btn.disabled = false;
    }
  } catch(e) { btn.textContent = 'âŒ Error'; btn.disabled = false; }
}

async function saveNotes(cartId) {
  const notes = document.getElementById('notes-' + cartId).value;
  await fetch('/api/carts/' + cartId + '/notes', { method: 'PATCH', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ notes }) });
}
</script>

<%- include('layout-foot') %>
